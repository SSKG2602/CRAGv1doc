<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ChronoRAG — Diagram Pack</title>
  <link rel="stylesheet" href="image.css">
</head>
<body>
  <div class="cover">
    <h1>ChronoRAG — Visual Reference Pack</h1>
    <p class="subtitle">Architecture, Dataflow, Policy, and Data Model — SVG diagrams with stable anchors</p>
    <div class="badges">
      <span class="badge">Python 3.11</span>
      <span class="badge">FastAPI</span>
      <span class="badge">PVDB</span>
      <span class="badge">BM25 + ANN</span>
      <span class="badge">Monotone Fusion</span>
      <span class="badge">ChronoSanity</span>
    </div>
  </div>

  <nav class="toc">
    <h2>Figures</h2>
    <ol>
      <li><a href="#fig-f1">F1. System Architecture (blocks)</a></li>
      <li><a href="#fig-f2">F2. Runtime Dataflow (swimlanes)</a></li>
      <li><a href="#fig-f3">F3. Policy & Configuration Flow</a></li>
      <li><a href="#fig-f4">F4. Retrieval Pipeline Detail</a></li>
      <li><a href="#fig-f5">F5. ChunkRecord Data Model</a></li>
      <li><a href="#fig-f6">F6. Modes & Temporal Windows</a></li>
    </ol>
  </nav>

  <!-- F1 -->
  <section id="fig-f1" class="fig">
    <h2>F1. System Architecture (blocks)</h2>
    <svg viewBox="0 0 980 360" width="100%" height="auto">
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#A5B4FC"></polygon>
        </marker>
      </defs>

      <!-- Row of core pipeline -->
      <rect class="node" x="20"  y="60" width="120" height="48"></rect>
      <text class="label" x="30" y="90">Client (REST/CLI)</text>

      <rect class="node" x="170" y="60" width="140" height="48"></rect>
      <text class="label" x="180" y="90">FastAPI Routes</text>

      <rect class="node" x="340" y="60" width="160" height="48"></rect>
      <text class="label" x="350" y="90">TemporalRouter</text>

      <rect class="node" x="530" y="60" width="170" height="48"></rect>
      <text class="label" x="540" y="90">Retrieve Service</text>

      <rect class="node" x="730" y="60" width="220" height="48"></rect>
      <text class="label" x="740" y="90">Answer Service → Generator</text>

      <!-- Arrows -->
      <line class="arrow" x1="140" y1="84" x2="170" y2="84"></line>
      <line class="arrow" x1="310" y1="84" x2="340" y2="84"></line>
      <line class="arrow" x1="500" y1="84" x2="530" y2="84"></line>
      <line class="arrow" x1="700" y1="84" x2="730" y2="84"></line>

      <!-- Stores and side components -->
      <rect class="store" x="380" y="160" width="140" height="64"></rect>
      <text class="label" x="390" y="185">PVDB + ANN</text>
      <text class="label" x="390" y="202">storage/pvdb</text>

      <rect class="store" x="560" y="160" width="140" height="64"></rect>
      <text class="label" x="570" y="185">BM25 + Reranker</text>
      <text class="label" x="570" y="202">core/retrieval</text>

      <rect class="store" x="740" y="160" width="180" height="64"></rect>
      <text class="label" x="750" y="185">ChronoReducer /</text>
      <text class="label" x="750" y="202">ChronoSanity</text>

      <!-- Connections -->
      <line class="arrow2" x1="610" y1="108" x2="450" y2="160"></line>
      <line class="arrow2" x1="610" y1="108" x2="630" y2="160"></line>
      <line class="arrow2" x1="840" y1="108" x2="830" y2="160"></line>

      <!-- Legend -->
      <text class="legend" x="20" y="320">Legend: pipeline blocks (cyan), stores/algorithms (purple), arrows show request/evidence flow.</text>
    </svg>
  </section>

  <!-- F2 -->
  <section id="fig-f2" class="fig">
    <h2>F2. Runtime Dataflow (swimlanes)</h2>
    <svg viewBox="0 0 980 420" width="100%" height="auto">
      <defs>
        <marker id="arrowhead2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#00E5FF"></polygon>
        </marker>
      </defs>

      <!-- Lanes -->
      <line class="swim" x1="120" y1="40" x2="120" y2="380"></line>
      <line class="swim" x1="320" y1="40" x2="320" y2="380"></line>
      <line class="swim" x1="620" y1="40" x2="620" y2="380"></line>
      <line class="swim" x1="860" y1="40" x2="860" y2="380"></line>
      <text class="laneLabel" x="30"  y="70">Client</text>
      <text class="laneLabel" x="180" y="70">API</text>
      <text class="laneLabel" x="450" y="70">Core</text>
      <text class="laneLabel" x="740" y="70">Storage</text>

      <!-- Steps -->
      <circle cx="90" cy="110" r="6" fill="#00E5FF"></circle>
      <text class="label" x="140" y="114">/ingest or CLI → payload</text>
      <line class="arrow" x1="120" y1="110" x2="320" y2="110"></line>

      <rect class="node" x="330" y="92" width="180" height="36"></rect>
      <text class="label" x="340" y="114">ingest_service.ingest()</text>
      <line class="arrow" x1="510" y1="110" x2="620" y2="110"></line>

      <rect class="store" x="630" y="92" width="200" height="36"></rect>
      <text class="label" x="640" y="114">PVDB.persist + ANN.embed</text>

      <!-- Route -->
      <circle cx="90" cy="170" r="6" fill="#00E5FF"></circle>
      <text class="label" x="140" y="174">/retrieve or /answer</text>
      <line class="arrow" x1="120" y1="170" x2="320" y2="170"></line>

      <rect class="node" x="330" y="152" width="180" height="36"></rect>
      <text class="label" x="340" y="174">TemporalRouter.route()</text>

      <!-- Retrieve -->
      <rect class="node" x="330" y="212" width="220" height="36"></rect>
      <text class="label" x="340" y="234">retrieve_service.retrieve()</text>
      <line class="arrow" x1="550" y1="230" x2="620" y2="230"></line>
      <rect class="store" x="630" y="212" width="200" height="36"></rect>
      <text class="label" x="640" y="234">BM25 + ANN + rerank</text>

      <!-- Reduce + ChronoSanity -->
      <rect class="node" x="330" y="272" width="240" height="36"></rect>
      <text class="label" x="340" y="294">ChronoReducer + ChronoSanity</text>

      <!-- Generate -->
      <rect class="node" x="330" y="332" width="220" height="36"></rect>
      <text class="label" x="340" y="354">generator.generate_answer()</text>
      <line class="arrow" x1="330" y1="350" x2="120" y2="350"></line>
      <text class="label" x="130" y="344">JSON answer / evidence digest</text>
    </svg>
  </section>

  <!-- F3 -->
  <section id="fig-f3" class="fig">
    <h2>F3. Policy & Configuration Flow</h2>
    <svg viewBox="0 0 980 360" width="100%" height="auto">
      <defs>
        <marker id="arrowhead3" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#A5B4FC"></polygon>
        </marker>
      </defs>
      <rect class="store" x="40" y="60" width="200" height="56"></rect>
      <text class="label" x="50" y="88">config/polar.yaml</text>
      <text class="label" x="50" y="104">weights, dhqc, thresholds</text>

      <rect class="store" x="40" y="140" width="200" height="56"></rect>
      <text class="label" x="50" y="168">config/axis_policy.yaml</text>
      <text class="label" x="50" y="184">axes, hard/soft rules</text>

      <rect class="store" x="40" y="220" width="200" height="56"></rect>
      <text class="label" x="50" y="248">config/models.yaml</text>
      <text class="label" x="50" y="264">embeds, reranker, LLM</text>

      <rect class="node" x="300" y="110" width="200" height="48"></rect>
      <text class="label" x="310" y="140">Policy Service (/policy)</text>

      <rect class="node" x="540" y="110" width="200" height="48"></rect>
      <text class="label" x="550" y="140">TemporalRouter</text>

      <rect class="node" x="780" y="110" width="160" height="48"></rect>
      <text class="label" x="790" y="140">Retrieve Service</text>

      <line class="arrow" x1="240" y1="88" x2="300" y2="120"></line>
      <line class="arrow" x1="240" y1="168" x2="300" y2="134"></line>
      <line class="arrow" x1="240" y1="248" x2="300" y2="144"></line>

      <line class="arrow" x1="500" y1="134" x2="540" y2="134"></line>
      <line class="arrow" x1="740" y1="134" x2="780" y2="134"></line>

      <text class="legend" x="40" y="310">/policy/apply updates in-memory state shared by API and CLI.</text>
    </svg>
  </section>

  <!-- F4 -->
  <section id="fig-f4" class="fig">
    <h2>F4. Retrieval Pipeline Detail</h2>
    <svg viewBox="0 0 980 360" width="100%" height="auto">
      <defs>
        <marker id="arrowhead4" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#A5B4FC"></polygon>
        </marker>
      </defs>

      <rect class="node" x="40"  y="70" width="170" height="44"></rect>
      <text class="label" x="50" y="96">BM25 (lexical)</text>

      <rect class="node" x="40"  y="140" width="170" height="44"></rect>
      <text class="label" x="50" y="166">ANN (embeddings)</text>

      <rect class="node" x="260" y="70" width="200" height="44"></rect>
      <text class="label" x="270" y="96">Temporal Pre‑Mask</text>

      <rect class="node" x="260" y="140" width="200" height="44"></rect>
      <text class="label" x="270" y="166">Cross‑Encoder Rerank</text>

      <rect class="node" x="500" y="105" width="220" height="44"></rect>
      <text class="label" x="510" y="132">Monotone Fusion (α,β,γ,δ)</text>

      <rect class="node" x="760" y="105" width="180" height="44"></rect>
      <text class="label" x="770" y="132">Top‑K Passages</text>

      <line class="arrow" x1="210" y1="92"  x2="260" y2="92"></line>
      <line class="arrow" x1="210" y1="160" x2="260" y2="160"></line>
      <line class="arrow" x1="460" y1="124" x2="500" y2="124"></line>
      <line class="arrow" x1="720" y1="124" x2="760" y2="124"></line>

      <text class="legend" x="40" y="320">Fusion weights live in config/polar.yaml; temporal masks enforce valid/tx overlap before fusion.</text>
    </svg>
  </section>

  <!-- F5 -->
  <section id="fig-f5" class="fig">
    <h2>F5. ChunkRecord Data Model</h2>
    <svg viewBox="0 0 980 420" width="100%" height="auto">
      <rect class="store" x="60" y="60" width="860" height="260"></rect>
      <text class="label" x="70" y="84">ChunkRecord</text>
      <text class="label" x="70" y="108">chunk_id, doc_id, text, uri, authority</text>
      <text class="label" x="70" y="128">valid_window(start,end), tx_window(start,end)</text>
      <text class="label" x="70" y="148">external_id, version_id</text>
      <text class="label" x="70" y="168">facets(tenant, domain, source, locale, fiscal_year_start)</text>
      <text class="label" x="70" y="188">entities[], tags[], units[]</text>
      <text class="label" x="70" y="208">time_granularity, time_sigma_days</text>
      <text class="label" x="70" y="228">embedding[]</text>
      <text class="label" x="70" y="248">extra metadata</text>
      <text class="legend" x="60" y="340">Idempotent updates via external_id; PVDB.shortens prior tx window on replacement.</text>
    </svg>
  </section>

  <!-- F6 -->
  <section id="fig-f6" class="fig">
    <h2>F6. Modes & Temporal Windows</h2>
    <svg viewBox="0 0 980 360" width="100%" height="auto">
      <rect class="node" x="60" y="70" width="240" height="44"></rect>
      <text class="label" x="70" y="96">Axis: VALID vs TRANSACTION</text>

      <rect class="node" x="360" y="70" width="220" height="44"></rect>
      <text class="label" x="370" y="96">Mode: HARD vs INTELLIGENT</text>

      <rect class="store" x="640" y="60" width="260" height="64"></rect>
      <text class="label" x="650" y="92">TimeWindow(start,end, overlap())</text>

      <text class="legend" x="60" y="160">HARD: strict overlap required → drop non‑overlapping passages.</text>
      <text class="legend" x="60" y="180">INTELLIGENT: distance‑based decay; softer temporal mask.</text>
      <text class="legend" x="60" y="200">Router snaps to HARD on policy rules (axis_policy.yaml).</text>
    </svg>
  </section>

  <div class="callout">
    <strong>Anchors:</strong> Use <span class="mono">#fig-f1</span> … <span class="mono">#fig-f6</span> for internal links.
    Update labels by editing the <span class="mono">&lt;text class="label"&gt;</span> nodes inside each figure.
  </div>

</body>
</html>
